# STAC: SRAM Timing Analysis Chip

High-level information:
* Submitting to Efabless ChipIgnite 2306Q
* Tapeout deadline: June 5, 2023
* Chips (supposedly) delivered: October 27, 2023
* Package: QFN, ~66 pins

# Organization

A rough top-level diagram of the chip is shown below:

![STAC top level diagram](./figures/stac_top.svg)

Each SRAM test block contains the following elements:

![A single SRAM test block](./figures/sram22_test_block.svg)

To the extent possible, the top level will be generated
by Chipyard/Hammer.

## Rocket

* A TinyRocket instance generated by Chipyard
* Has an option to allow all internal SRAMs to by bypassed
* Communicates with the SRAM test blocks via memory-mapped I/O

The Rocket communicates with the SRAM test blocks via MMIO only.
The test blocks do not participate in the memory hierarchy of the core.

## SRAM Test Blocks

The SRAM test area uses the following pins:
* `clk`: The global clock
* `SRAM_SCAN_IN`: SRAM scan chain input
* `SRAM_SCAN_OUT`: SRAM scan chain output
* `SRAM_SCAN_RST`: Resets the SRAM scan chain to all 0s
* `SRAM_SCAN_EN`: Enables scan chain mode
* `SRAM_SAE_CLK`: The used to drive the SRAM sense amplifiers
* `SRAM_RSTB`:  An active-low reset for all SRAM test circuitry, except the scan chain.
* `TDC_EN`: Enables all TDCs. When low, TDCs holds their values.
* `SRAM_EN`: A global chip enable for all SRAM blocks. When setting up SRAM inputs (via scan chain or MMIO), should be held low; once the inputs are ready and stable, this should be set high (usually for one cycle).
* `BIST_EN`: Enables all BIST modules.
* `SRAM_TEST_EN`: Enables manual test mode for all SRAMs.
   When high, SRAMs are enabled by `SRAM_EN`.
   When low, SRAMs are enabled by the SRAM enable Rocket MMIO register.

Note that there are no dual-clock scan chain FFs in the open-source SKY130 PDK.
(Dual-clock FFs have a scan clock port and an independent system clock port.)

```verilog
// Signals for the i'th SRAM block
assign sram_en_i = SRAM_TEST_EN ? SRAM_EN : mmio_sram_en;
assign sram_sel_i = SRAM_TEST_EN ? scan_sram_sel : mmio_sram_sel;

// `tdc_en_i` is an input to the TDC clock gating cell described in the TDC config section
assign tdc_en_i = SRAM_TEST_EN ? TDC_EN : mmio_tdc_en;

always @(*) begin
  case (sram_sel_i)
    SRAM_SEL_BIST : addr_i = bist_addr_i;
    SRAM_SEL_SCAN: addr_i = scan_addr_i;
    SRAM_SEL_MMIO: addr_i = mmio_addr_i;
    default: addr_i = 0;
  endcase
end
```

scan chain -> mux -> sram
register (from mmio) -> mux

Clock should be held low when not in use.

### Scan Chain

Each scan chain register looks approximately like this:

![Scan chain register](./figures/scan_flop.jpg)

Note that there is only one clock. So moving data in and out of the scan chains
requires toggling the global clock.

When scan enable (SE) is high, the scan chain behaves like a shift register.
Data is shifted in from the scan in (SI) port, and shifted out at the scan out (SO)
port. In the diagram above, Q and SO are always the same value.


### MMIO Structure

The table below describes the MMIO registers for a
`DxW` SRAM with `WM` mask bits and `A = clog2(D)` address bits.
`D` is the depth of the SRAM; `W` is the width.

| Name     | Width | Direction     | Description         | 
| -------- | ----- | ------------- | ------------------- |
| `addr`   | A     | R/W           | Read/write address  |
| `din`    | W     | R/W           | Write data          |
| `wmask`  | WM+1  | R/W           | `{we, wmask[WM-1:0]}` |
| `dout`   | W     | RO            | Data read from SRAM |
| `tdc`    | TBD   | RO            | TDC output code     |
| `ex`     | 1     | WO            | Set high for one cycle to begin a mem op |
| `done`   | 1     | RO            | High when a mem op completes |

Each SRAM operation will take approximately 5 cycles to complete.
Roughly 1 cycle to set up SRAM inputs, 1 cycle for operation, and 3 cycles for TDC synchronization.

There are also MMIO registers for the BIST.

| Name     | Width | Direction     | Description         | 
| -------- | ----- | ------------- | ------------------- |
| `bist_rst` | 1   | WO            | BIST reset          |
| `bist_start_pattern` | 4   | R/W | BIST starting pattern |
| `bist_status` | 32 | RO            | `{done, fail, pattern, location}` |
| `bist_expected` | W | RO            | BIST expected data |
| `bist_received` | W | RO            | BIST received data |


* Address
* Write mask
* Data in
* Data out
* BIST fail flag, addr, expected, received, pattern, location within pattern.
  For example, "BIST failed on address 0x123. Expected data 0x123, got 0x124 at pattern 2, step number 4".

### TDC Configuration

The TDC takes as input an early clock and a late clock. It measures the time difference between
a rising edge of the early clock and a rising edge of the late clock, and produces a
thermometer-encoded digital signal. In the absence of rising edges on the late clock,
the TDC value is held constant.


## PLL

Sean may provide a BAG/Hammer-generated PLL instance,
with Spice/GDS/LEF/LIB collateral.

A global clock mux selects between the PLL-generated clock
and an externally-provided clock.
